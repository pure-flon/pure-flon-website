# Pure-Flon Website - GitHub Actions Workflow
# ìë™ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ë¥¼ ìœ„í•œ CI/CD íŒŒì´í”„ë¼ì¸

name: ğŸš€ Deploy Pure-Flon Website

on:
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
  push:
    branches: [ main ]
  
  # Pull Requestê°€ mainì— ìƒì„±ë  ë•Œ ì‹¤í–‰
  pull_request:
    branches: [ main ]
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ§¹ HTML Validation
        run: npm run validate
        continue-on-error: true
        
      - name: ğŸ“ CSS Linting
        run: |
          npx stylelint "css/**/*.css" --config-basedir .
        continue-on-error: true
        
      - name: ğŸ” JavaScript Linting
        run: |
          npx eslint js/**/*.js --fix-dry-run
        continue-on-error: true

  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  lighthouse-test:
    name: ğŸš¨ Lighthouse Performance Test
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸƒâ€â™‚ï¸ Start local server
        run: |
          npm run dev &
          sleep 10
        
      - name: ğŸš¨ Run Lighthouse
        run: |
          npm run lighthouse
        continue-on-error: true
        
      - name: ğŸ“Š Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lighthouse-report.html
          retention-days: 30

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“¤ Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: [quality-check]
    
    strategy:
      matrix:
        node-version: [18, 20]
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ğŸ“š Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build project
        run: npm run build
        
      - name: ğŸ“Š Check build size
        run: |
          echo "ğŸ“¦ Build size analysis:"
          du -sh dist/
          find dist/ -name "*.css" -exec echo "CSS: {}" \; -exec wc -c {} \;
          find dist/ -name "*.js" -exec echo "JS: {}" \; -exec wc -c {} \;
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files-node-${{ matrix.node-version }}
          path: dist/
          retention-days: 7

  # Vercel í”„ë¦¬ë·° ë°°í¬ (PRìš©)
  deploy-preview:
    name: ğŸ” Deploy Preview
    runs-on: ubuntu-latest
    needs: [build-test]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel (Preview)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./
          
      - name: ğŸ’¬ Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ” Preview deployment')
            );
            
            const body = `ğŸ” **Preview deployment ready!**
            
            âœ… Build successful
            ğŸŒ Preview URL: Available in Vercel dashboard
            ğŸ“Š Lighthouse report: Check the artifacts
            
            This preview will be automatically updated on new commits.`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # í”„ë¡œë•ì…˜ ë°°í¬ (main ë¸Œëœì¹˜)
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://pure-flon.com
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel (Production)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./
          
      - name: ğŸ§ª Post-deployment smoke test
        run: |
          echo "ğŸ§ª Running smoke tests..."
          
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          curl -f https://pure-flon.com/ > /dev/null || exit 1
          echo "âœ… Main page OK"
          
          # ì œí’ˆ í˜ì´ì§€ë“¤ í…ŒìŠ¤íŠ¸
          curl -f https://pure-flon.com/products/medical.html > /dev/null || exit 1
          echo "âœ… Medical page OK"
          
          curl -f https://pure-flon.com/products/semiconductor.html > /dev/null || exit 1
          echo "âœ… Semiconductor page OK"
          
          curl -f https://pure-flon.com/products/chemical.html > /dev/null || exit 1
          echo "âœ… Chemical page OK"
          
          # sitemap.xml í…ŒìŠ¤íŠ¸
          curl -f https://pure-flon.com/sitemap.xml > /dev/null || exit 1
          echo "âœ… Sitemap OK"
          
          echo "ğŸ‰ All smoke tests passed!"
          
      - name: ğŸ“¢ Notify deployment success
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { sha } = context;
            
            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: 'success',
              target_url: 'https://pure-flon.com',
              description: 'ğŸš€ Successfully deployed to production',
              context: 'deployment/production'
            });

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-failure:
    name: ğŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: failure()
    
    steps:
      - name: ğŸš¨ Create issue on deployment failure
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const { sha, workflow, run_number } = context;
            
            await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸš¨ Deployment Failed - Workflow #${run_number}`,
              body: `## Deployment Failure Report
              
              **Workflow:** ${workflow}
              **Run Number:** ${run_number}
              **Commit:** ${sha}
              **Time:** ${new Date().toISOString()}
              
              The production deployment has failed. Please check the workflow logs and take necessary action.
              
              ### Quick Actions:
              - [ ] Check workflow logs
              - [ ] Verify Vercel configuration
              - [ ] Test locally
              - [ ] Fix issues and re-deploy
              
              **Logs:** [View Workflow Run](https://github.com/${owner}/${repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'deployment', 'urgent']
            });

# í™˜ê²½ ë³€ìˆ˜ ë° ì‹œí¬ë¦¿ ì„¤ì • ê°€ì´ë“œ:
#
# GitHub ì €ì¥ì†Œ â†’ Settings â†’ Secrets and variables â†’ Actionsì—ì„œ ë‹¤ìŒ ì„¤ì •:
#
# VERCEL_TOKEN: Vercel ê³„ì • â†’ Settings â†’ Tokensì—ì„œ ìƒì„±
# VERCEL_ORG_ID: Vercel í”„ë¡œì íŠ¸ â†’ Settings â†’ Generalì—ì„œ í™•ì¸
# VERCEL_PROJECT_ID: Vercel í”„ë¡œì íŠ¸ â†’ Settings â†’ Generalì—ì„œ í™•ì¸